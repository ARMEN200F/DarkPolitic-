<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>РСОН</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#000; color:#f00; font-family:Arial; text-align:center; margin:0; padding:0; }
.box { background:#111; padding:20px; margin:20px auto; max-width:600px; text-align:center; position:relative; }
button { background:#f00; color:#fff; border:none; padding:10px 15px; cursor:pointer; margin:5px; }
textarea { width:90%; background:#222; color:#fff; border:1px solid #444; padding:8px; margin:10px 0; display:block; }
.article { border-left:4px solid #f00; padding:10px; margin:15px 0; background:#151515; text-align:left; position:relative; }
.comment { background:#222; padding:6px; margin:6px 0; }
.delete-btn { background:#f00; color:#fff; border:none; padding:3px 5px; cursor:pointer; margin-left:5px; }
</style>
</head>
<body>

<div id="loginBox" class="box">
<h2>Добро пожаловать в РСОН</h2>
<button id="userBtn">Войти как обычный пользователь</button>
<button id="authorBtn">Войти как автор</button>
</div>

<div id="authorLogin" class="box" style="display:none">
<input id="promo" placeholder="Промокод">
<button id="checkPromoBtn">Войти</button>
</div>

<div id="authorPanel" class="box" style="display:none">
<h3>Написать статью</h3>
<textarea id="articleText" placeholder="Напишите текст статьи"></textarea>
<button id="publishBtn">Опубликовать</button>
<h3>Статьи</h3>
<div id="list"></div>
</div>

<div id="userPanel" class="box" style="display:none">
<h3>Статьи</h3>
<div id="listUser"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Подключение Supabase
const supabaseUrl = 'https://qjditkvtmgjtzquhmbxa.supabase.co';
const supabaseKey = 'sb_publishable_56UCHWD0G_x4DhspybwbCQ_YoBJR3MV';
const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

let IS_AUTHOR = false;

const loginBox = document.getElementById('loginBox');
const authorLogin = document.getElementById('authorLogin');
const authorPanel = document.getElementById('authorPanel');
const userPanel = document.getElementById('userPanel');
const articleText = document.getElementById('articleText');
const list = document.getElementById('list');
const listUser = document.getElementById('listUser');

// Вход
document.getElementById('userBtn').addEventListener('click', ()=>{
  IS_AUTHOR=false; loginBox.style.display='none'; userPanel.style.display='block'; loadArticlesUser();
});

document.getElementById('authorBtn').addEventListener('click', ()=>{
  loginBox.style.display='none'; authorLogin.style.display='block';
});

// Проверка промокода
document.getElementById('checkPromoBtn').addEventListener('click', async ()=>{
  if(promo.value==='120812'){ 
    IS_AUTHOR=true; authorLogin.style.display='none'; authorPanel.style.display='block';
    loadArticles();
  } else alert('Неверно');
});

// Публикация статьи
document.getElementById('publishBtn').onclick=async()=>{
  const text = articleText.value.trim();
  if(!text) return;
  await supabase.from('articles').insert([{text, likes:0, comments:[]}]);
  articleText.value='';
  loadArticles();
};

// Загрузка статей автора
async function loadArticles(){
  let { data: articles } = await supabase.from('articles').select('*').order('id', {ascending:false});
  list.innerHTML='';
  articles.forEach(a=>{
    const div = document.createElement('div');
    div.className='article';
    let html = '';
    if(IS_AUTHOR){
      html += `<div style="text-align:right;"><button class="delete-btn" onclick="deleteArticle('${a.id}')">Удалить статью</button></div>`;
    }
    html += `<p>${a.text}</p>
      <button onclick="like('${a.id}',${a.likes})">❤️ ${a.likes}</button>
      <div id="comments-${a.id}">${(a.comments||[]).map((c,i)=>IS_AUTHOR?`<div class="comment">${c} <button class="delete-btn" onclick="deleteComment('${a.id}','${c}')">Удалить</button></div>`:`<div class="comment">${c}</div>`).join('')}</div>
      <textarea id="c${a.id}" placeholder="Комментарий"></textarea>
      <button onclick="comment('${a.id}')">Отправить</button>
    `;
    div.innerHTML = html;
    list.appendChild(div);
  });
}

// Загрузка статей пользователя
async function loadArticlesUser(){
  let { data: articles } = await supabase.from('articles').select('*').order('id', {ascending:false});
  listUser.innerHTML='';
  articles.forEach(a=>{
    const div = document.createElement('div');
    div.className='article';
    div.innerHTML = `<p>${a.text}</p>
      <button onclick="like('${a.id}',${a.likes})">❤️ ${a.likes}</button>
      <div id="comments-${a.id}">${(a.comments||[]).map(c=>`<div class="comment">${c}</div>`).join('')}</div>
      <textarea id="c${a.id}" placeholder="Комментарий"></textarea>
      <button onclick="comment('${a.id}')">Отправить</button>
    `;
    listUser.appendChild(div);
  });
}

// Лайки
async function like(id,l){
  await supabase.from('articles').update({likes:l+1}).eq('id',id);
  if(IS_AUTHOR) loadArticles(); else loadArticlesUser();
}

// Комментарии
async function comment(id){
  const t = document.getElementById("c"+id).value;
  if(!t) return;
  await supabase.from('articles').update({comments:Supabase.arrayAppend('comments', t)}).eq('id',id);
  document.getElementById("c"+id).value='';
  if(IS_AUTHOR) loadArticles(); else loadArticlesUser();
}

// Удаление статьи
async function deleteArticle(id){
  if(!IS_AUTHOR) return;
  if(confirm('Удалить статью?')){
    await supabase.from('articles').delete().eq('id', id);
    loadArticles();
  }
}

// Удаление комментария
async function deleteComment(articleId, commentText){
  if(!IS_AUTHOR) return;
  await supabase.from('articles').update({comments:Supabase.arrayRemove('comments', commentText)}).eq('id', articleId);
  loadArticles();
}
</script>
</body>
</html>