<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>RSON</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#000; color:#f00; font-family:Arial; text-align:center; margin:0; padding:20px; }
button { background:#800000; color:#fff; border:none; padding:10px 15px; cursor:pointer; margin:8px 0; width:100%; font-size:16px; }
textarea, input { width:100%; background:#222; color:#fff; border:1px solid #444; padding:8px; margin:5px 0; font-size:16px; }
.post { border-left:4px solid #f00; padding:10px; margin:15px 0; background:#151515; text-align:left; position:relative; }
.comment { background:#222; padding:6px; margin:6px 0; position:relative; }
.delete-btn { background:#f00; color:#fff; border:none; padding:3px 5px; cursor:pointer; margin-left:5px; }
</style>
</head>
<body>

<h1 id="title">Добро пожаловать</h1>

<div id="login">
  <button onclick="loginAuthor()">Войти как автор</button>
  <button onclick="loginUser()">Войти как пользователь</button>
</div>

<div id="authorPanel" style="display:none">
  <h2>Новая статья</h2>
  <input id="postTitle" placeholder="Заголовок">
  <textarea id="postText" placeholder="Текст статьи"></textarea>
  <button onclick="publish()">Опубликовать</button>
</div>

<h2>Статьи</h2>
<div id="posts"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBAixfevL-T7BFz2iLb4jS1vcQ3nJBACuU",
  authDomain: "rson-2005b.firebaseapp.com",
  projectId: "rson-2005b",
  storageBucket: "rson-2005b.firebasestorage.app",
  messagingSenderId: "1026695255902",
  appId: "1:1026695255902:web:5858543731ca7b44ace1cf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let isAuthor = false;

window.loginAuthor = () => {
  const code = prompt("Введите код автора:");
  if (code === "120812") {
    isAuthor = true;
    document.getElementById("authorPanel").style.display = "block";
    document.getElementById("login").style.display = "none";
    document.getElementById("title").innerText = "Режим автора";
  } else {
    alert("Неверный код");
  }
};

window.loginUser = () => {
  document.getElementById("login").style.display = "none";
  document.getElementById("title").innerText = "Режим пользователя";
};

window.publish = async () => {
  const title = postTitle.value.trim();
  const text = postText.value.trim();
  if (!title || !text) return alert("Заполни всё");
  await addDoc(collection(db, "posts"), { title, text, comments: [], likes:0, time: Date.now() });
  postTitle.value = "";
  postText.value = "";
};

const postsDiv = document.getElementById("posts");

onSnapshot(collection(db, "posts"), snap => {
  postsDiv.innerHTML = "";
  snap.forEach(d => {
    const p = d.data();
    const div = document.createElement("div");
    div.className = "post";
    
    let commentsHTML = (p.comments||[]).map((c,index)=>{
      if(isAuthor){
        return `<div class="comment">${c} <button class="delete-btn" onclick="deleteComment('${d.id}','${c}')">Удалить</button></div>`;
      } else {
        return `<div class="comment">${c}</div>`;
      }
    }).join("");

    div.innerHTML = `<h3>${p.title}</h3><p>${p.text}</p>
      <button onclick="like('${d.id}',${p.likes})">❤️ ${p.likes}</button>
      ${commentsHTML}
      <textarea id="c${d.id}" placeholder="Комментарий"></textarea>
      <button onclick="comment('${d.id}')">Отправить</button>
      ${isAuthor?'<button onclick="deletePost(\''+d.id+'\')">Удалить статью</button>':''}`;
    
    postsDiv.appendChild(div);
  });
});

window.like = async (id,l) => {
  const ref = doc(db,"posts",id);
  await updateDoc(ref,{likes:l+1});
};

window.comment = async (id) => {
  const t = document.getElementById("c"+id).value.trim();
  if(!t) return;
  const ref = doc(db,"posts",id);
  await updateDoc(ref,{comments:arrayUnion(t)});
  document.getElementById("c"+id).value="";
};

window.deleteComment = async (postId,commentText) => {
  const ref = doc(db,"posts",postId);
  await updateDoc(ref,{comments:arrayRemove(commentText)});
};

window.deletePost = async (postId) => {
  if(confirm("Удалить статью?")){
    await deleteDoc(doc(db,"posts",postId));
  }
};
</script>

</body>
</html>